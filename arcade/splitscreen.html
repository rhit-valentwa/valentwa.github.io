<!DOCTYPE html>
<html>
<head>
    <title>SplitScreen</title>
    <script src="../scripts/processing.js"></script>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const canvas = document.getElementById("canvas");
            const processing = new Processing(canvas, function(processing) {
                processing.size(400, 400);
                processing.background(0xFFF);

                let mouseIsPressed = false;
                let keyIsPressed = false;
                const downKeys = {};

                processing.mousePressed = () => { mouseIsPressed = true; };
                processing.mouseReleased = () => { mouseIsPressed = false; };

                processing.keyPressed = () => { keyIsPressed = true; downKeys[processing.keyCode] = true; };
                processing.keyReleased = () => { keyIsPressed = false; downKeys[processing.keyCode] = false; };

                const getImage = (s) => {
                    const url = "https://www.kasandbox.org/programming-images/" + s + ".png";
                    processing.externals.sketch.imageCache.add(url);
                    return processing.loadImage(url);
                };

                const rotateFn = processing.rotate;
                processing.rotate = (angle) => {
                    rotateFn(processing.radians(angle));
                };

                const gameMapBase = processing.createGraphics(400, 400, processing.P2D);
                const gameMapRaised = processing.createGraphics(400, 400, processing.P2D);

                const redFOV = processing.createGraphics(620, 420, processing.P2D);
                const blueFOV = processing.createGraphics(620, 420, processing.P2D);

                gameMapRaised.noStroke();

                redFOV.background(255, 0);
                blueFOV.background(255, 0);

                const plr1 = { x: 50, y: 200, c: 0 };
                const plr2 = { x: 570, y: 200, c: 0 };

                const coins = [];

                const Tree = (ctx, x, y) => {
                    ctx.fill(163, 109, 0);
                    ctx.rect(x, y, 20, 97);
                    ctx.fill(0, 212, 92);
                    ctx.rect(x - 40, y - 90, 100, 100);
                };

                const update = () => {
                    gameMapRaised.background(0, 189, 82);

                    Tree(gameMapRaised, 202, 233);
                    Tree(gameMapRaised, 319, 40);
                    Tree(gameMapRaised, 456, -39);
                    Tree(gameMapRaised, 474, 200);
                    Tree(gameMapRaised, 116, 88);

                    gameMapRaised.fill(252, 252, 252);
                    gameMapRaised.rect(plr1.x + 150, plr1.y + 100, 20, 20, 6);
                    gameMapRaised.rect(plr2.x - 210, plr2.y + 100, 20, 20, 6);

                    processing.image(gameMapRaised.get(plr1.x - 40, plr1.y, 400, 200), 0, -5);
                    processing.image(redFOV.get(plr1.x - 40, plr1.y, 400, 200), 0, 0);
                    processing.image(gameMapRaised.get(plr2.x - 400, plr2.y, 400, 200), 0, 200);
                    processing.image(blueFOV.get(plr2.x - 400, plr2.y, 400, 200), 0, 200);
                };

                const movePlayer = (player, dx, dy) => {
                    player.x += dx;
                    player.y += dy;
                };

                processing.draw = () => {
                    processing.background(0, 0, 0);

                    if (downKeys[87]) { movePlayer(plr1, 0, -5); }  // W
                    if (downKeys[83]) { movePlayer(plr1, 0, 5); }   // S
                    if (downKeys[65]) { movePlayer(plr1, -5, 0); }  // A
                    if (downKeys[68]) { movePlayer(plr1, 5, 0); }   // D

                    if (downKeys[processing.UP]) { movePlayer(plr2, 0, -5); }
                    if (downKeys[processing.DOWN]) { movePlayer(plr2, 0, 5); }
                    if (downKeys[processing.LEFT]) { movePlayer(plr2, -5, 0); }
                    if (downKeys[processing.RIGHT]) { movePlayer(plr2, 5, 0); }

                    update();
                };
            });
        });
    </script>
</body>
</html>